# maven.test.nvim

A Neovim plugin that provides Maven integration for testing Java projects. It uses Neovim's treesitter to detect Java test files and provides commands to run and debug tests using Maven.

Users can select to run:
- A single test method
- An entire test class
- All tests in the project

## Project Structure

```
lua/maven-test/
├── init.lua              - Plugin entry point, setup, and configuration
├── commands.lua          - User command registration (MavenTest, MavenTestClass, etc.)
├── functions.lua         - High-level functions that connect commands to runner
├── parser.lua            - Treesitter-based parsing to detect test methods and classes
├── runner.lua            - Executes Maven commands in terminal
├── ui.lua                - Core floating window UI components and command editor
├── ui-tests.lua          - Test selector UI with two-pane layout (actions and commands)
├── ui-commands.lua       - Command list UI for viewing and managing stored commands
├── store.lua             - Command storage and retrieval
└── store_persistence.lua - Saves/loads command store to/from disk

plugin/init.lua           - Auto-setup and default keymaps
```

## Features

- **Treesitter Detection**: Automatically detects Java test methods annotated with `@Test` and `@ArchTest` (including fields)
- **Test Execution**: Run individual methods, entire classes, or all tests
- **Debug Mode**: Run tests with Maven Surefire debug mode (waits for debugger on port 5005)
- **Interactive UI**: Floating window with test selector showing available tests and preview of the command to be executed
- **Terminal Output**: Test output displayed in a split terminal window within Neovim
- **Command Storage**: Stores and persists Maven commands per project in `~/.local/share/nvim/maven.nvim.test/<project-name>/store.json`

## User Commands

The plugin registers the following commands:

- `:MavenTest` - Opens floating window to select and run a specific test method
- `:MavenTestClass` - Runs all tests in the current class
- `:MavenTestAll` - Runs all tests in the project
- `:MavenTestDebug` - Opens floating window to select and debug a specific test method
- `:MavenTestClassDebug` - Debugs all tests in the current class
- `:MavenTestAllDebug` - Debugs all tests in the project
- `:MavenTestCommands` - Opens floating window to view, edit, delete, and run stored Maven commands
- `:MavenTestRestoreCommandsStore` - Restores the command store from disk

## Default Keymaps

Defined in `plugin/init.lua`:

- `<leader>Mtt` - Open test selector (`:MavenTest`)
- `<leader>Mtc` - Run current class tests (`:MavenTestClass`)
- `<leader>Mta` - Run all tests (`:MavenTestAll`)
- `<leader>Mtdt` - Open test selector in debug mode (`:MavenTestDebug`)
- `<leader>Mtdc` - Run current class tests in debug mode (`:MavenTestClassDebug`)
- `<leader>Mtda` - Run all tests in debug mode (`:MavenTestAllDebug`)

These use `<Plug>` mappings and can be overridden by users.

## Configuration

The plugin can be configured via `setup()`:

```lua
require('maven-test').setup({
  maven_command = "mvn",           -- Maven command to use
  debug_port = 5005,               -- Port for Maven Surefire debug mode
  floating_window = {
    width = 0.8,                   -- 80% of editor width
    height = 0.6,                  -- 60% of editor height
    border = "rounded",            -- Border style
  },
  data_dir = "<auto-generated>",   -- Command store location (per project)
})
```

## UI Behavior

### Test Selector UI (`:MavenTest`, `:MavenTestDebug`)

When the user triggers `:MavenTest` or `:MavenTestDebug`:

1. A floating window appears with two sections:
   - **Top section (actions)**: List of test methods and option to run all tests in class
   - **Bottom section (commands)**: Preview of Maven command(s) that will be executed

2. Navigation:
   - Use `j/k` or arrow keys to move through the list in the actions section
   - Press `<Space>` to switch focus to the commands section
   - Press `<Enter>` to execute the selected test
   - Press `m` in commands section to edit the selected command
   - Press `d` in commands section to delete the selected command (if more than one exists)
   - Press `q` or `<Esc>` to close the window

3. The preview updates dynamically as the cursor moves to show the exact command(s) for the selected item

4. Upon selection, a terminal split opens at the bottom showing Maven output in real-time

### Command List UI (`:MavenTestCommands`)

When the user triggers `:MavenTestCommands`:

1. A floating window displays all stored Maven commands for the current action type

2. Navigation:
   - Use `j/k` or arrow keys to move through the command list
   - Press `<Enter>` or `<Space>` to execute the selected command
   - Press `m` to edit the selected command
   - Press `d` to delete the selected command
   - Press `q` or `<Esc>` to close the window

3. The command list updates automatically when commands are deleted

### Command Editor

When editing a command (via `m` keymap):

1. A floating window appears with the current command as editable text
2. The editor starts in insert mode for immediate editing
3. Press `<Enter>` in normal mode to save changes and return to the previous UI
4. Press `<Esc>` or `q` in normal mode to cancel and return without saving

## Parser Details

The parser (`parser.lua`) uses treesitter queries to find:

- **`@Test` methods**: Standard JUnit test methods
- **`@ArchTest` methods**: ArchUnit test methods
- **`@ArchTest` fields**: ArchUnit test rules defined as fields

It extracts:
- Method/field name
- Line number
- Type (currently always "method")

## Runner Details

The runner (`runner.lua`) constructs Maven commands:

- **Run method**: `mvn test -Dtest=com.example.ClassName#methodName`
- **Run class**: `mvn test -Dtest=com.example.ClassName`
- **Run all**: `mvn test`
- **Debug mode**: Adds `-Dmaven.surefire.debug` flag (Surefire waits on port 5005)

Commands are executed in a new terminal split using `jobstart()` with `term = true`.

## Command Store

The store maintains multiple Maven command templates per action type. Keys used:

- `run_all` - Command to run all tests
- `run_class` - Command template to run a test class (uses `%s` placeholder)
- `run_method` - Command template to run a test method (uses `%s` placeholder)
- `run_all_debug` - Debug version of run_all
- `run_class_debug` - Debug version of run_class
- `run_method_debug` - Debug version of run_method

### Store API

Located in `store.lua`:

```lua
-- Add command to store (inserts at front if unique)
add_to_store(key, value)

-- Remove command from store
remove_from_store(key, value)

-- Get first command for key (most recently used)
first(key)

-- Get all commands for key
get(key)

-- Load store from disk
load()
```

### Store Persistence

Located in `store_persistence.lua`:

```lua
-- Initialize with data directory path
initialize(datadir)

-- Save store to disk as JSON
save(store_data)

-- Load store from disk
load()
```

Store file location: `~/.local/share/nvim/maven.nvim.test/<project-name>/store.json`


### UI Modules

The UI is split into three modules:

- **`ui.lua`**: Core floating window components and the command editor
  - `FloatingWindow` class for creating floating windows
  - `show_command_editor()` function for editing commands
  
- **`ui-tests.lua`**: Test selector with two-pane layout
  - Top pane: Lists test methods and test class with line numbers
  - Bottom pane: Shows available commands for the selected test
  - Supports navigation between panes with `<Space>`
  - Allows editing (`m`) and deleting (`d`) commands from the bottom pane
  
- **`ui-commands.lua`**: Command list viewer and manager
  - Single-pane window showing all stored commands for an action
  - Supports running (`<Enter>`), editing (`m`), and deleting (`d`) commands
  - Updates the UI automatically after deletions<Enter>, q and <Esc>).

## Code Design Principles

### Architecture
- **Separation of Concerns**: Each module has a single responsibility
  - `parser.lua`: Treesitter integration and test detection
  - `runner.lua`: Maven command execution
  - `ui.lua`: User interface and interaction
  - `store.lua`: In-memory command storage
  - `store_persistence.lua`: Disk persistence layer
  - `commands.lua`: Neovim command registration
  - `functions.lua`: Business logic coordination
  
### Module Dependencies
```
init.lua → commands.lua → functions.lua → [parser.lua, runner.lua, ui-tests.lua, ui-commands.lua]
                                        ↓                              ↓
                                    store.lua                       ui.lua
                                        ↓
                                store_persistence.lua
```

### Key Design Patterns
- **Plug Mappings**: All keymaps use `<Plug>` mappings to allow user customization
- **Store-First Architecture**: Commands are stored and retrieved from the store, not hard-coded
- **Separation of Data and View**: Store manages data, UI displays it
- **Single Terminal Strategy**: Only one test terminal split is maintained at a time

## Non-Functional Requirements

### Store Behavior
- **Non-nil Guarantee**: The store always returns a non-nil value (empty table if no data exists)
- **Uniqueness**: The store does not add an item if it is already present in the list
- **Order Preservation**: Most recently used commands are inserted at the front of the list
- **Persistence**: Store is automatically saved to disk after modifications
- **Per-Project Isolation**: Each project has its own isolated store file

### Keymap Requirements
- **Plug Mappings Only**: All shortcut commands must be of type `<Plug>` to allow user override
- No mapping defined by the plugin. All mapping should be defined by the user. Document how the mapping should be done.

### Performance
- **Lazy Loading**: Plugin loads only when needed (via autocommands or explicit commands)
- **Fast Parsing**: Treesitter queries are efficient and run only on current buffer
- **Async Execution**: Maven commands run asynchronously in terminal without blocking editor

### Reliability
- **Graceful Degradation**: If treesitter parser is unavailable, commands should still work for class/all tests
- **Error Handling**: Invalid Maven commands or missing files should display clear error messages
- **Safe Persistence**: Store file corruption should not crash the plugin

### User Experience
- **Real-time Feedback**: Command preview updates instantly as user navigates
- **Terminal Integration**: Maven output appears in Neovim terminal, not external window
- **Visual Clarity**: UI clearly separates test list from command preview

## Implementation Notes

- The plugin auto-initializes via `plugin/init.lua` when loaded
- Store is loaded on plugin setup from the data directory
- Default Maven commands are added to the store on registration
- The UI shows **all** commands in the store for a given action (to support future custom command editing)
- Currently, only the first command is executed, but the store supports multiple commands per key
- Package name is extracted from the Java file's `package` declaration (first 50 lines)
- Test class name is extracted via treesitter query for `class_declaration`
- Store operations are idempotent - adding the same command twice has no effect

## Recent Changes

- Split UI into three modules (`ui.lua`, `ui-tests.lua`, `ui-commands.lua`) for better separation of concerns
- Added command editing functionality: users can now modify stored commands via `m` keymap
- Added command deletion functionality: users can delete stored commands via `d` keymap
- Added `:MavenTestCommands` command to view and manage all stored commands
- Command editor opens in insert mode for immediate editing
- UI updates automatically after command deletions
- Command editor preserves multi-line commands

## Future Improvements

- Integration with telescope/fzf for better selection UI
- Per-project configuration files for custom arguments
- Support for additional test frameworks (TestNG, etc.)
- Command history and selection of previously run commands
- Ability to run tests from the last run without opening the selector
- Command templates with user-defined variables
